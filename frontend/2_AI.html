<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>가꿈 - AI 디자인 결과</title>
    <!-- Tailwind CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <!-- 구글 폰트 -->
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Space Grotesk', sans-serif;
        }
        :root {
            --gradient-primary: linear-gradient(135deg, #6366F1, #A855F7);
        }
        .gradient-text {
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .canvas-bg {
            background: linear-gradient(135deg, #EEF2FF 0%, #F5F3FF 100%);
            position: relative;
            overflow: hidden;
        }
        .canvas-bg::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 1px 1px, #6366F1 1px, transparent 0),
                radial-gradient(circle at 1px 1px, #A855F7 1px, transparent 0);
            background-size: 30px 30px, 50px 50px;
            background-position: 0 0, 15px 15px;
            opacity: 0.1;
        }
        .card-hover {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .card-hover:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(99, 102, 241, 0.15);
        }
        .gradient-border {
            position: relative;
            background: linear-gradient(white, white) padding-box,
                        var(--gradient-primary) border-box;
            border: 2px solid transparent;
        }
        .style-card {
            transition: all 0.3s ease;
            border: 2px solid transparent;
            cursor: pointer;
        }
        .style-card:hover, .style-card.active {
            border-image: linear-gradient(135deg, #6366F1, #A855F7) 1;
            transform: translateY(-2px);
        }
        .tool-button {
            transition: all 0.3s ease;
        }
        .tool-button:hover {
            background: var(--gradient-primary);
            color: white;
            transform: translateY(-2px);
        }
        /* 로딩 애니메이션 */
        .loading {
            display: inline-block;
            position: relative;
            width: 80px;
            height: 80px;
        }
        .loading div {
            position: absolute;
            border: 4px solid #6366F1;
            opacity: 1;
            border-radius: 50%;
            animation: loading 1s cubic-bezier(0, 0.2, 0.8, 1) infinite;
        }
        .loading div:nth-child(2) {
            animation-delay: -0.5s;
        }
        @keyframes loading {
            0% {
                top: 36px;
                left: 36px;
                width: 0;
                height: 0;
                opacity: 1;
            }
            100% {
                top: 0px;
                left: 0px;
                width: 72px;
                height: 72px;
                opacity: 0;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="fixed w-full z-50 glass-effect">
        <div class="container mx-auto px-6">
            <nav class="flex items-center justify-between h-20">
                <a href="index.html" class="text-2xl font-bold gradient-text tracking-tight">가꿈</a>
                <div class="hidden md:flex">
                    <span class="text-gray-700 text-lg">Where Dreams Are Drawn ⁞ 앨리스 AI Spark Camp ⁞ 1조</span>
                </div>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="pt-32 pb-24">
        <div class="container mx-auto px-6">
            <!-- Title Section -->
            <div class="text-center max-w-3xl mx-auto mb-16">
                <h1 class="text-6xl font-bold mb-6">
                    AI가 생성한
                    <span class="gradient-text">디자인 결과</span>
                </h1>
                <p class="text-xl text-gray-600">
                    AI가 스케치를 기반으로 제작한 가구 디자인을 확인하고 수정하세요.
                </p>
            </div>

            <!-- Main Workspace -->
            <div class="grid lg:grid-cols-12 gap-8 mb-16">
                <!-- Style & Materials Panel -->
                <div class="lg:col-span-3 space-y-6">
                    <!-- Styles 박스 -->
                    <div class="bg-white rounded-3xl p-6 shadow-lg card-hover">
                        <h3 class="text-lg font-bold mb-6 gradient-text">Styles</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="style-card p-4 rounded-xl bg-gray-50" data-style="모던">
                                <img src="img/Modern.png" alt="모던" class="w-full h-24 object-cover rounded-lg mb-2 gradient-border">
                                <p class="text-sm font-medium">모던</p>
                            </div>
                            <div class="style-card p-4 rounded-xl bg-gray-50" data-style="클래식">
                                <img src="img/Classic.png" alt="클래식" class="w-full h-24 object-cover rounded-lg mb-2 gradient-border">
                                <p class="text-sm font-medium">클래식</p>
                            </div>
                            <div class="style-card p-4 rounded-xl bg-gray-50" data-style="미니멀">
                                <img src="img/Minimal.png" alt="미니멀" class="w-full h-24 object-cover rounded-lg mb-2 gradient-border">
                                <p class="text-sm font-medium">미니멀</p>
                            </div>
                            <div class="style-card p-4 rounded-xl bg-gray-50" data-style="북유럽">
                                <img src="img/Scandinavian.png" alt="북유럽" class="w-full h-24 object-cover rounded-lg mb-2 gradient-border">
                                <p class="text-sm font-medium">북유럽</p>
                            </div>
                        </div>
                    </div>

                    <!-- Materials 박스 -->
                    <div class="bg-white rounded-3xl p-6 shadow-lg card-hover">
                        <h3 class="text-lg font-bold mb-6 gradient-text">Materials</h3>
                        <div class="space-y-4">
                            <div class="style-card p-4 rounded-xl bg-gray-50" data-material="원목">
                                <div class="flex items-center space-x-3">
                                    <img src="img/Wood.png" alt="원목" class="w-12 h-12 object-cover rounded-lg gradient-border">
                                    <div>
                                        <p class="font-medium">원목</p>
                                        <p class="text-sm text-gray-500">자연스러운 나무 질감</p>
                                    </div>
                                </div>
                            </div>
                            <div class="style-card p-4 rounded-xl bg-gray-50" data-material="메탈">
                                <div class="flex items-center space-x-3">
                                    <img src="img/Metal.png" alt="메탈" class="w-12 h-12 object-cover rounded-lg gradient-border">
                                    <div>
                                        <p class="font-medium">메탈</p>
                                        <p class="text-sm text-gray-500">현대적인 금속 마감</p>
                                    </div>
                                </div>
                            </div>
                            <div class="style-card p-4 rounded-xl bg-gray-50" data-material="페브릭">
                                <div class="flex items-center space-x-3">
                                    <img src="img/Fabric.png" alt="페브릭" class="w-12 h-12 object-cover rounded-lg gradient-border">
                                    <div>
                                        <p class="font-medium">페브릭</p>
                                        <p class="text-sm text-gray-500">부드러운 천 소재</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Preview Area -->
                <div class="lg:col-span-6">
                    <div class="canvas-bg rounded-3xl p-8 shadow-lg">
                        <div class="gradient-border rounded-2xl bg-white p-4">
                            <!-- 이미지와 로딩 표시기를 포함하는 컨테이너 -->
                            <div class="flex justify-center items-center relative" style="min-height: 256px;">
                                <!-- 로딩 애니메이션 -->
                                <div id="loadingIndicator" class="loading absolute" style="display: none;">
                                    <div></div>
                                    <div></div>
                                </div>
                                <!-- 이미지 -->
                                <img id="designPreview" src="" alt="Design Preview" class="rounded-xl w-full max-w-[710px] mx-auto">
                            </div>
                            <div class="flex justify-between items-center mt-4">
                                <div>
                                    <!-- 버전 / 수정일 표시 -->
                                    <h3 id="previewVersion" class="font-semibold text-lg">현재 버전: v1.0</h3>
                                    <p id="previewDate" class="text-gray-500 text-sm">최종 수정: <span id="currentDate"></span></p>
                                </div>
                                <!-- 저장하기 & 공유하기 버튼 -->
                                <div class="flex space-x-3">
                                    <button id="savePreviewButton" class="p-2 hover:bg-gray-100 rounded-lg transition-colors flex items-center space-x-1">
                                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                            d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
                                        </svg>
                                        <span class="text-sm">저장하기</span>
                                    </button>
                                    <button id="sharePreviewButton" class="p-2 hover:bg-gray-100 rounded-lg transition-colors flex items-center space-x-1">
                                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                                        </svg>
                                        <span class="text-sm">공유하기</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Controls Panel -->
                <div class="lg:col-span-3 space-y-6">
                    <!-- Design Feedback 영역 -->
                    <div class="bg-white rounded-3xl p-6 shadow-lg card-hover">
                        <h3 class="text-lg font-bold mb-6 gradient-text">Design Feedback</h3>
                        <div class="flex flex-col gap-4">
                            <!-- 입력 영역 -->
                            <textarea 
                                id="feedbackPrompt"
                                class="w-full h-32 p-4 rounded-xl border-2 gradient-border focus:ring-2 focus:ring-indigo-500 transition-all resize-none"
                                placeholder="가구 스타일/재질 변경에 대해 설명해주세요..."></textarea>
                            
                            <!-- 맞춤법 검사 결과 영역 -->
                            <div id="spellResult" class="w-full p-4 rounded-xl border-2 gradient-border bg-gray-50 text-sm max-h-32 overflow-auto hidden">
                                맞춤법 검사 결과가 표시됩니다.
                            </div>
                            
                            <div class="flex space-x-2">
                                <!-- 맞춤법 검사 버튼 -->
                                <button id="spellCheckBtn" class="flex-grow bg-indigo-100 text-indigo-600 py-2 rounded-xl hover:bg-indigo-200 transition-all">
                                    맞춤법 검사
                                </button>
                                
                                <!-- 수정 요청 버튼 -->
                                <button id="feedbackSubmit" class="flex-grow bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-2 rounded-xl hover:opacity-90 transition-all">
                                    수정 요청하기
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Saved Version 영역 -->
                    <div id="versionsContainer" class="bg-white rounded-3xl p-6 shadow-lg card-hover">
                        <h3 class="text-lg font-bold mb-6 gradient-text">Recommendation</h3>
                        <button onclick="goToPage()" class="tool-button w-full gradient-border rounded-xl p-4 text-left hover:bg-gray-50 transition-all group">
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="font-medium mb-1">유사한 가구 추천받기</p>
                                    <p class="text-sm text-gray-500">약 2-3분 소요됩니다</p>
                                </div>
                                <svg class="w-6 h-6 text-indigo-600 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                                </svg>
                            </div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 중복된 스크립트 정리 -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 현재 날짜 설정
            const now = new Date();
            const formattedDate = `${now.getFullYear()}.${String(now.getMonth() + 1).padStart(2, '0')}.${String(now.getDate()).padStart(2, '0')}`;
            document.getElementById('currentDate').textContent = formattedDate;
            
            // 스타일/재질 선택 처리
            const styleCards = document.querySelectorAll('.style-card');
            
            styleCards.forEach(card => {
                card.addEventListener('click', function() {
                    const style = this.getAttribute('data-style');
                    const material = this.getAttribute('data-material');
                    let prompt = '';
                    
                    // 같은 카테고리의 다른 카드에서 active 클래스 제거
                    const siblings = this.parentElement.querySelectorAll('.style-card');
                    siblings.forEach(sibling => sibling.classList.remove('active'));
                    
                    // 현재 카드에 active 클래스 추가
                    this.classList.add('active');
                    
                    // 스타일 또는 재질에 따라 프롬프트 텍스트 필드에 텍스트 추가
                    const promptText = document.getElementById('feedbackPrompt');
                    if (style) {
                        prompt = `${style} 스타일로 변경해주세요`;
                    } else if (material) {
                        prompt = `${material} 재질로 변경해주세요`;
                    }
                    
                    // 기존 텍스트가 있으면 줄바꿈 후 추가
                    if (promptText.value.trim() !== '') {
                        promptText.value += '\n' + prompt;
                    } else {
                        promptText.value = prompt;
                    }
                });
            });
            
            // 초기 이미지 로드
            const previewImage = document.getElementById("designPreview");
            const loadingIndicator = document.getElementById("loadingIndicator");
            const storedImage = localStorage.getItem("aiDesignImage");
            
            if (storedImage) {
                previewImage.src = storedImage;
            }
            
            // 저장하기 버튼
            const savePreviewButton = document.getElementById("savePreviewButton");
            savePreviewButton.addEventListener("click", function () {
                if (!previewImage.src) return;
                
                const tempCanvas = document.createElement("canvas");
                const ctx = tempCanvas.getContext("2d");
                tempCanvas.width = previewImage.naturalWidth || 512;
                tempCanvas.height = previewImage.naturalHeight || 512;
                ctx.drawImage(previewImage, 0, 0);
                const dataURL = tempCanvas.toDataURL("image/png");
                
                const link = document.createElement("a");
                link.href = dataURL;
                link.download = `가구디자인_${new Date().toISOString().slice(0,10)}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
            
            // 공유하기 버튼
            const sharePreviewButton = document.getElementById("sharePreviewButton");
            sharePreviewButton.addEventListener("click", async function () {
                if (!previewImage.src) return;
                
                try {
                    const tempCanvas = document.createElement("canvas");
                    const ctx = tempCanvas.getContext("2d");
                    tempCanvas.width = previewImage.naturalWidth || 512;
                    tempCanvas.height = previewImage.naturalHeight || 512;
                    ctx.drawImage(previewImage, 0, 0);
                    
                    tempCanvas.toBlob(async function(blob) {
                        try {
                            const item = new ClipboardItem({ "image/png": blob });
                            await navigator.clipboard.write([item]);
                            alert("이미지가 클립보드에 복사되었습니다!\n이미지를 붙여넣기하여 공유하세요.");
                        } catch (err) {
                            console.error("이미지 복사 실패", err);
                            // 대체 방법: 캔버스 내용을 새 창에 표시
                            const dataUrl = tempCanvas.toDataURL('image/png');
                            const newWindow = window.open();
                            newWindow.document.write(`<img src="${dataUrl}" alt="가구 디자인">`);
                        }
                    }, "image/png");
                } catch (err) {
                    console.error("클립보드 공유 실패", err);
                    alert("이미지 공유에 실패했습니다.");
                }
            });
            
            // 로딩 표시 관리 함수
            window.showLoading = function() {
                loadingIndicator.style.display = 'block';
                previewImage.style.opacity = '0.3';
            }
            
            window.hideLoading = function() {
                loadingIndicator.style.display = 'none';
                previewImage.style.opacity = '1';
            }

            // saveNewVersion 함수 정의
            window.saveNewVersion = function(prompt, imageUrl) {
                console.log("새 버전 저장:", prompt, imageUrl);
                // 필요시 로컬스토리지에 정보 추가 저장
                localStorage.setItem("lastPrompt", prompt);
                localStorage.setItem("aiDesignImage", imageUrl);
            };
        });
        
        // 페이지 이동 함수 수정 - 다운로드 없이 바로 이동
        function goToPage() {
            // 이미지가 존재하는지만 확인
            const previewImage = document.getElementById("designPreview");
            if (!previewImage.src || previewImage.src === "about:blank") {
                alert("생성된 이미지가 없습니다. 먼저 이미지를 생성해주세요.");
                return;
            }
            
            // 현재 이미지 소스를 그대로 localStorage에 저장하고 이동
            localStorage.setItem("aiDesignImage", previewImage.src);
            window.location.href = "3_recommend.html";
        }
    </script>

    <!-- 맞춤법 검사 스크립트 -->
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const feedbackTextEl = document.getElementById("feedbackPrompt");
            const resultBox = document.getElementById("spellResult");
            const spellCheckBtn = document.getElementById("spellCheckBtn");
            
            spellCheckBtn.addEventListener("click", function() {
                const text = feedbackTextEl.value;
                if (!text.trim()) {
                    alert("검사할 텍스트를 입력해주세요.");
                    return;
                }

                // 결과 영역 표시 및 로딩 상태 표시
                resultBox.classList.remove("hidden");
                resultBox.textContent = "맞춤법 검사 중...";

                fetch("https://jjaqzskahktzmmgb.tunnel-pt.elice.io/proxy/8000/check", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ text: text })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        resultBox.innerHTML = `<span class="text-red-500">오류 발생: ${data.error}</span>`;
                    } else {
                        if (data.checked_text === text) {
                            resultBox.innerHTML = `<span class="text-green-500">맞춤법 오류가 없습니다.</span>`;
                        } else {
                            resultBox.innerHTML = `
                                <div class="mb-2 text-green-600 font-medium">맞춤법 교정 결과:</div>
                                <div class="text-gray-700">${data.checked_text}</div>
                            `;
                        }
                    }
                })
                .catch(error => {
                    console.error("맞춤법 검사 실패:", error);
                    resultBox.innerHTML = `<span class="text-red-500">맞춤법 검사에 실패했습니다.</span>`;
                });
            });
        });
    </script>

    <!-- 피드백 제출 및 이미지 수정 요청 -->
    <script>
        document.getElementById("feedbackSubmit").addEventListener("click", async function() {
            const prompt = document.getElementById("feedbackPrompt").value;
            if (!prompt) {
                alert("수정할 내용을 입력해주세요.");
                return;
            }
            const imageUrl = document.getElementById("designPreview").src;
            if (!imageUrl) {
                alert("수정할 이미지가 없습니다.");
                return;
            }
            
            try {
                // 이미지 로드
                const imageResponse = await fetch(imageUrl);
                if (!imageResponse.ok) {
                    throw new Error("이미지 불러오기 실패");
                }
                
                // 블롭으로 변환
                const blob = await imageResponse.blob();
                const file = new File([blob], "original.png", { type: "image/png" });
                
                // FormData 구성
                const formData = new FormData();
                formData.append("original_image", file);
                formData.append("prompt", prompt);
                
                // 로딩 표시 시작
                window.showLoading();
                
                // API 요청 전송
                const response = await fetch("https://jjaqzskahktzmmgb.tunnel-pt.elice.io/proxy/8000/edit-image", {
                    method: "POST",
                    body: formData
                });
                
                // 응답 처리
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || "수정 요청 실패");
                }
                
                // 결과 처리
                const data = await response.json();
                if (data.result_url) {
                    // URL을 그대로 사용 (다운로드 없이)
                    document.getElementById("designPreview").src = data.result_url;
                    
                    // localStorage에 URL 저장
                    localStorage.setItem("aiDesignImage", data.result_url);
                    localStorage.setItem("lastPrompt", prompt);
                    
                    console.log("이미지 URL이 업데이트되었습니다:", data.result_url);
                } else {
                    alert("결과 이미지가 없습니다.");
                }
            } catch (error) {
                console.error("수정 요청 실패:", error);
                alert("수정 요청에 실패했습니다: " + error.message);
            } finally {
                window.hideLoading();
            }
        });
    </script>
</body>
</html>